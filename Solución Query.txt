/* CREACIÓN DE LA BASE DE DATOS */ 
CREATE DATABASE EL_CLIENTE

/* USAR BASE DE DATOS RECIEN CREADA */
USE EL_CLIENTE
GO

/* CREACIÓN DE TABLAS */

-- TABLA CLIENTE
CREATE TABLE Cliente (id int primary key identity (1,1), nombre nvarchar(100) NOT NULL, apellidos nvarchar(100) NOT NULL, ciudad nvarchar(100) NOT NULL)

-- TABLA SUCURSAL
CREATE TABLE Sucursal (id int primary key identity (1,1), nombre nvarchar(100) NOT NULL, ciudad nvarchar(100) NOT NULL)

-- TABLA PRODUCTO
CREATE TABLE Producto (id int primary key identity (1,1), nombre nvarchar(100) NOT NULL, tipoProducto nvarchar(50) NOT NULL)

-- TABLE INSCRIPCIÓN
CREATE TABLE Inscripcion (idProducto int, idCliente int, PRIMARY KEY (idProducto, idCliente))

-- TABLE DISPONIBILIDAD
CREATE TABLE Disponibilidad (idSucursal int, idProducto int, PRIMARY KEY (idSucursal, idProducto))

-- TABLE Visitan
CREATE TABLE Visitan (idSucursal int, idCliente int, fechaVisita date NOT NULL, PRIMARY KEY (idSucursal, idCliente))

/* ASIGNACIÓN DE LLAVES FORÁNEAS */

-- TABLA INSCRIPCIÓN - FK idProducto
ALTER TABLE Inscripcion ADD FOREIGN KEY (idProducto) REFERENCES Producto (id)

-- TABLA INSCRIPCIÓN - FK idCliente
ALTER TABLE Inscripcion ADD FOREIGN KEY (idCliente) REFERENCES Cliente (id)

-- TABLA DISPONIBILIDAD - FK idSucursal
ALTER TABLE Disponibilidad ADD FOREIGN KEY (idSucursal) REFERENCES Sucursal (id)

-- TABLA DISPONIBILIDAD - FK idProducto
ALTER TABLE Disponibilidad ADD FOREIGN KEY (idProducto) REFERENCES Producto (id)

-- TABLA VISITAN - FK idProducto
ALTER TABLE Visitan ADD FOREIGN KEY (idSucursal) REFERENCES Sucursal (id)

-- TABLA VISITAN - FK idProducto
ALTER TABLE Visitan ADD FOREIGN KEY (idCliente) REFERENCES Cliente (id)

/* INSERCIÓN DE DATOS*/

-- INSERTAR CLIENTES
INSERT INTO Cliente (nombre, apellidos, ciudad)
VALUES 
('Carlos', 'Pérez', 'Bogotá'),
('María', 'Gómez', 'Medellín'),
('Juan', 'Rodríguez', 'Bogotá');

-- INSERTAR SUCURSALES
INSERT INTO Sucursal (nombre, ciudad)
VALUES 
('Sucursal Centro', 'Bogotá'),
('Sucursal Norte', 'Medellín'),
('Sucursal Sur', 'Bogotá');

-- INSERTAR PRODUCTOS
INSERT INTO Producto (nombre, tipoProducto)
VALUES 
('Laptop', 'Electrónica'),
('Bicicleta', 'Deporte'),
('Cafetera', 'Hogar');

-- INSERTAR INSCRIPCIONES DE PRODUCTOS POR CLIENTES
INSERT INTO Inscripcion (idProducto, idCliente)
VALUES 
(1, 1), -- Carlos inscrito en Laptop
(2, 2), -- María inscrita en Bicicleta
(3, 3); -- Juan inscrito en Cafetera

-- INSERTAR DISPONIBILIDADES DE PRODUCTOS POR SUCURSAL
INSERT INTO Disponibilidad (idSucursal, idProducto)
VALUES 
(1, 1), -- Laptop disponible en Sucursal Centro
(2, 2), -- Bicicleta disponible en Sucursal Norte
(3, 3), -- Cafetera disponible en Sucursal Sur
(1, 3); -- Cafetera también en Sucursal Centro

-- VISITAS DE CLIENTES A SUCURSALES
INSERT INTO Visitan (idSucursal, idCliente, fechaVisita)
VALUES 
(1, 1, '2025-08-01'), -- Carlos visita Sucursal Centro
(2, 2, '2025-08-02'), -- María visita Sucursal Norte
(3, 3, '2025-08-03'), -- Juan visita Sucursal Sur
(1, 3, '2025-08-05'); -- Juan también visita Sucursal Centro


/* Obtener los nombres de los clientes los cuales tienen inscrito algún producto disponible sólo en las 
sucursales que visitan. */

SELECT DISTINCT c.nombre, c.apellidos
FROM Cliente c
JOIN Inscripcion i ON c.id = i.idCliente
JOIN Disponibilidad d ON i.idProducto = d.idProducto
JOIN Visitan v ON c.id = v.idCliente AND d.idSucursal = v.idSucursal
WHERE NOT EXISTS (
    SELECT 1
    FROM Disponibilidad d2
    WHERE d2.idProducto = i.idProducto
      AND d2.idSucursal NOT IN (
          SELECT v2.idSucursal
          FROM Visitan v2
          WHERE v2.idCliente = c.id
      )
);
